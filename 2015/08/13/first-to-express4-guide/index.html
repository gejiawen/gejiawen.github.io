

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="gejiawen">
    
    <meta name="description" content="Express是基于Nodejs以及一系列Nodejs第三方package的一款Web开发框架。
Express经历过2.x，3.x以及最新的4.x版本。Express各个版本的差异还是比较大的。现在2.x版本官方已经不再维护（deprecated），3.x版本虽然可以使用，但是官方建议升级到4.x">
    
    

    
    <link rel="alternative" href="atom.xml" title="蛋糕仙人" type="application/atom+xml">
    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Express4入门指南 | 蛋糕仙人 · 技术人需要危机感</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script>
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    
    <meta name="baidu-site-verification" content="SzJ3MGdmeo" />


    <meta name="360-site-verification" content="afe5dc96bbb8d111b618f78493b95bb8" />


    <!--<meta name="baidu-site-verification" content="SzJ3MGdmeo" />-->
    <!--<meta name="360-site-verification" content="afe5dc96bbb8d111b618f78493b95bb8" />-->

</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://blog.gejiawen.com" title="蛋糕仙人">蛋糕仙人</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a class="max-width max-w300" title="技术人需要危机感" href="/feelings">技术人需要危机感</a>
                    </li>
                </ul>
                

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index">
                        <a href="/" target="">首页</a>
                    </li>
                    
                    <li id="nav-archives">
                        <a href="/archives" target="">归档</a>
                    </li>
                    
                    <li id="nav-categories">
                        <a href="/categories" target="">分类</a>
                    </li>
                    
                    <li id="nav-tags">
                        <a href="/tags" target="">标签</a>
                    </li>
                    
                    <li id="nav-pick">
                        <a href="http://book.gejiawen.com/fucking-days-to-be-a-coder" target="_blank">拾遗</a>
                    </li>
                    
                    <li id="nav-about">
                        <a href="/about" target="">关于</a>
                    </li>
                    

                    <li id="nav-github"><a href="https://github.com/gejiawen" target="_blank">GitHub</a></li>
                    <!--<li id="nav-rss"><a href="/atom.xml" target="_blank">Rss</a></li>-->
                    <li id="nav-search"><input type="text" id="search" placeholder="search" /></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
    var bgRoot = "http://7xkwt1.com1.z0.glb.clouddn.com/background-";
    var bgLength = "74";
    var bgRandom = false;
    var bgImage = "http://7xkwt1.com1.z0.glb.clouddn.com/background-64.jpg";

    $(function() {
        // page-id...
        var pageId = "2015/08/13/first-to-express4-guide/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";

        $("#nav-" + pageId).addClass("active");
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>Express4入门指南</h1>

        <div class="time-info">
            
<span class="article-tags">
    
    Tags: <a href="/tags/nodejs/">nodejs</a>&nbsp;<a href="/tags/漫游NodeJS系列/">漫游NodeJS系列</a>&nbsp;
</span>



<span class="article-categories">
    Category:
    <a class="article-category-link" href="/categories/NODEJS/">NODEJS</a>
</span>


        </div>
        <div class="time-info">
            发表: <time datetime="2015-08-13T06:52:29.000Z"
                       itemprop="datePublished">2015-08-13 14:52:29</time>
            
            更新: <time datetime="2017-01-15T17:16:24.000Z"
                       itemprop="dateModified">2017-01-16 01:16:24</time>
            
        </div>

        <div class="post-body-inner">
            
                <div id="toc" class="toc-article well">
                    <strong class="toc-title">大纲</strong>
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#安装和基本示例"><span class="toc-number">1.</span> <span class="toc-text">安装和基本示例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#工作原理"><span class="toc-number">2.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#中间件机制"><span class="toc-number">3.</span> <span class="toc-text">中间件机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#中间件的分类"><span class="toc-number">3.1.</span> <span class="toc-text">中间件的分类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Router机制"><span class="toc-number">4.</span> <span class="toc-text">Router机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#模式匹配和参数"><span class="toc-number">4.1.</span> <span class="toc-text">模式匹配和参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由回调"><span class="toc-number">4.2.</span> <span class="toc-text">路由回调</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#app-router"><span class="toc-number">4.3.</span> <span class="toc-text">app.router()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模板引擎"><span class="toc-number">5.</span> <span class="toc-text">模板引擎</span></a></li></ol>
                </div>
            

            <p><a href="http://expressjs.com/" target="_blank" rel="external">Express</a>是基于<a href="https://nodejs.org/" target="_blank" rel="external">Nodejs</a>以及一系列Nodejs第三方package的一款Web开发框架。</p>
<p>Express经历过2.x，3.x以及最新的4.x版本。Express各个版本的差异还是比较大的。现在2.x版本官方已经不再维护（deprecated），3.x版本虽然可以使用，但是官方建议升级到4.x版本。如果你之前使用的express 3.x版本，官方也有给出迁移到4.x的<a href="http://expressjs.com/guide/migrating-4.html" target="_blank" rel="external">指南</a>。</p>
<p>本文围绕express的Routing和Middleware机制，作一些讨论。主要参考express官网的guide。</p>
<h1 id="安装和基本示例"><a href="#安装和基本示例" class="headerlink" title="安装和基本示例"></a>安装和基本示例</h1><p>我们首先从最基本的讲起。首先我们得有一个nodejs项目，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; mkdir <span class="built_in">test</span> &amp; <span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line">&gt; npm init</span><br></pre></td></tr></table></figure>
<p>我一般习惯使用<code>npm init</code>来创建一个nodejs项目。因为它可以提供一个交互式的命令行来生成最基本的<code>package.json</code>文件。</p>
<p>在创建好<code>package.json</code>文件之后，接下来我们就需要安装express了，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; npm install express --save</span><br></pre></td></tr></table></figure>
<p>我们使用<code>--save</code>选项自动更新<code>package.json</code>的<code>dependencies</code>字段。在express安装结束之后，<code>package.json</code>就变成了下面这样了，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"test"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"kick off express4"</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"keywords"</span>: [</span><br><span class="line">    <span class="string">"nodejs"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">"gejiawen"</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"express"</span>: <span class="string">"^4.13.3"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据你系统的差异或者网络因素，你可能需要使用<code>sudo npm install express --save</code>，或者是<code>sudo cnpm install express --save</code>。</p>
<p>使用npm安装包的时候，除了<code>--save</code>选项，我们还可以使用<code>--save-dev</code>。两者在安装完包之后，都可以自动更新<code>package.json</code>文件，不同的是，前者更新的是<code>dependencies</code>字段，后者更新的是<code>devDependencies</code>字段。而<code>dependencies</code>和<code>devDependencies</code>的区别可以简单的理解成，前者是生产环境所需要的依赖，而后者是开发环境所需要的依赖。</p>
<p>在安装完毕express之后，我们需要新建一个启动文件，就是<code>package.json</code>中<code>main</code>字段指定的文件。当然你说我能不能新建一个文件叫别的什么名字，那当然也是没问题的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; touch index.js</span><br></pre></td></tr></table></figure>
<p><code>index.js</code>文件的内容如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'Hello world!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'app is listening at localhost:3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>最后再启动这个文件，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; node index.js</span><br></pre></td></tr></table></figure>
<p>至此，我们使用express开发的一个最最简单的web程序就完成了。可以我浏览器输入<code>localhost:3000</code>，看看效果吧。</p>
<h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><p>经过上面的简单示例，看起来使用express做web真的非常简单。为什么可以做到这么简单呢？这是跟express的设计理念有关系的。</p>
<p>整个express应用可以简单的抽象成一系列的路由和中间件。当然这些路由和中间件之间存在着调用和先后关系。</p>
<p>那么，路由和中间件具体又是指的是什么呢？</p>
<p>简单来说，express中的路由可以看成一种<strong>path watcher</strong>，比如上面示例中的代码，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'Hello world!'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这段代码中，express app将监控<code>/</code>路径，来自客户端所有对<code>/</code>路径的请求，都使用后面的回调函数处理。</p>
<p>而这里的处理请求的<strong>回调函数</strong>其实就是所谓的中间件。</p>
<p>所以，中间件其实就是<strong>处理HTTP请求</strong>的回调函数，一般来说它会有3个参数，分别是<code>req</code>，<code>res</code>和<code>next</code>，分别表示请求对象，响应对象以及next回调。next回调的作用是将控制权传递给下一个中间件。</p>
<p>如果一个中间件是专门用于错误处理的，它将会有4个参数，分别是<code>err</code>，<code>req</code>，<code>res</code>，<code>next</code>。其中第一个参数表示错误对象。</p>
<p>中间件的基本执行过程是这样的，<strong>在中间件内部对req和res对象进行处理加工，执行相关逻辑，然后根据业务决定是否执行<code>next（）</code>函数，传递到下一个中间件</strong>。</p>
<p>除此之外，一般我们建议一个中间件只专注做一件事，也就是说中间件的职责尽量单一，这样利于维护和协调中间件。</p>
<h1 id="中间件机制"><a href="#中间件机制" class="headerlink" title="中间件机制"></a>中间件机制</h1><p>下面我们来详细的说一说express的中间件机制。</p>
<p>其实所谓的中间件就是一个函数回调。express中采用<code>use</code>来注册中间件。比如，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expresss = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Time: '</span>, <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// more code...</span></span><br></pre></td></tr></table></figure>
<p>如上例所示，这个中间件是整个app的第一个中间件，当有请求过来时，它将会被第一个调用，在console中打印出时间信息。执行完毕之后，通过<code>next()</code>将执行权传递给后面的中间件。</p>
<p>此外，我们可以再中间件内容做一些额外的事情，比如对请求路径的判断，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (request.url === <span class="string">"/"</span>) &#123;</span><br><span class="line">        response.writeHead(<span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span> &#125;);</span><br><span class="line">        response.end(<span class="string">"Welcome to the homepage!\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.url === <span class="string">"/about"</span>) &#123;</span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span> &#125;);</span><br><span class="line">        res.end(<span class="string">"about page!\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">404</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span> &#125;);</span><br><span class="line">    res.end(<span class="string">"404 error!\n"</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>上面的代码表示，</p>
<ul>
<li>如果请求的是<code>/</code>路径，返回给客户端<code>Welcome to the homepage!</code>。如果是其他路径，就调用下一个中间件。</li>
<li>第二个中间件中，判断路径是否是<code>/about</code>，如果是，将返回给客户端<code>about page!</code>。如果不是，调用下一个中间件。</li>
<li>当执行权传递到第三个中间件时，那么客户端请求的路径不是<code>/</code>也不是<code>/about</code>，此时我们将给出一个<code>404 error!</code>的提示，并同时终止中间件的继续调用。</li>
</ul>
<p>从上面的示例代码，我们足以管中窥豹，领略一下express中间件机制，以及它们的调用策略。简单来说就是，<strong>express按照顺序执行中间件，每个中间件做好自己的任务并决定是否调用下一个中间件</strong>。</p>
<h2 id="中间件的分类"><a href="#中间件的分类" class="headerlink" title="中间件的分类"></a>中间件的分类</h2><p>express的官网上对中间件作了个分类，包含如下几种，</p>
<ul>
<li><a href="http://expressjs.com/guide/using-middleware.html#middleware.application" target="_blank" rel="external">Application-level middleware</a>（应用级别中间件）</li>
<li><a href="http://expressjs.com/guide/using-middleware.html#middleware.router" target="_blank" rel="external">Router-level middleware</a>（路由级别中间件）</li>
<li><a href="http://expressjs.com/guide/using-middleware.html#middleware.error-handling" target="_blank" rel="external">Error-handling middleware</a>（错误处理中间件）</li>
<li><a href="http://expressjs.com/guide/using-middleware.html#middleware.built-in" target="_blank" rel="external">Built-in middleware</a>（内置中间件）</li>
<li><a href="http://expressjs.com/guide/using-middleware.html#middleware.third-party" target="_blank" rel="external">Third-party middleware</a>（第三方中间件）</li>
</ul>
<p>应用级别的中间件其实就是指挂在<code>app</code>上的中间件。通常我们除了可以通过<code>app.use</code>来挂载中间件之外，express还提供了<code>app.METHOD</code>这种方式。这里的<code>METHOD</code>指的是http的方法。比如</p>
<ul>
<li><code>app.get</code></li>
<li><code>app.post</code></li>
<li><code>app.put</code></li>
</ul>
<p>除此之外，还有一个特别的动词我们也可以使用，就是<code>app.all()</code>，它表示所有的请求都会通过这个中间件。看下面的示例代码，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.all(<span class="string">"*"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response, next</span>) </span>&#123;</span><br><span class="line">    response.writeHead(<span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span> &#125;);</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    response.end(<span class="string">"Welcome to the homepage!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"/about"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    response.end(<span class="string">"Welcome to the about page!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">"*"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    response.end(<span class="string">"404!"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>所有的请求都将会执行第一个中间，用户设置http响应的头信息。如果请求的是<code>/</code>或者<code>/about</code>，则执行相应的中间件。这里注意，第二个和第三个中间件都没有调用<code>next()</code>，所以他们执行完毕之后，并不会调用后面的中间件。如果请求的路径不是<code>/</code>或者<code>/about</code>，那么第二个和第三个中间件都将不会被调用，第四个中间件将会被调用。</p>
<p>所以说，express应用中中间件的顺序是很重要的，它将影响中间件的执行顺序。</p>
<h1 id="Router机制"><a href="#Router机制" class="headerlink" title="Router机制"></a>Router机制</h1><p>前面我们知道，可以通过<code>app.use</code>或者是<code>app.METHOD(&#39;/&#39;)</code>来配置路由。</p>
<p>在Express4中，路由成了一个单独的组件，express提供了一个新的对象<code>express.Router</code>，可以通过它来更好的配置路由。我们先来看一个示例，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// birds.js</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.use(<span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Time: '</span>, <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'Birds home page'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/about'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'Birds about page'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> birds = <span class="built_in">require</span>(<span class="string">'./birds'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'app home page'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/birds'</span>, birds);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server starting...'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>通过这个简单的例子，我们可以独立封装一组路由成为一个路由中间件，在主文件中可以根据需要挂在到不同的路径上，如<code>app.use(&#39;/birds&#39;, birds)</code>。这样一来，路由中间件中对路由的配置最终会被解析成如下，</p>
<ul>
<li><code>/birds/</code></li>
<li><code>/birds/about/</code></li>
</ul>
<p>我们使用express进行web开发的时候，一般也是推荐建立一个routes文件夹，将所有页面的路径配置都抽象成一个路由中间件，然后在主文件中挂载。</p>
<h2 id="模式匹配和参数"><a href="#模式匹配和参数" class="headerlink" title="模式匹配和参数"></a>模式匹配和参数</h2><p>使用进行路由配置的时候，我们不仅仅可以使用字符常量，还可以使用字符串的模式匹配，如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// will match acd and abcd</span></span><br><span class="line">app.get(<span class="string">'/ab?cd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'ab?cd'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// will match abcd, abbcd, abbbcd, and so on</span></span><br><span class="line">app.get(<span class="string">'/ab+cd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'ab+cd'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// will match abcd, abxcd, abRABDOMcd, ab123cd, and so on</span></span><br><span class="line">app.get(<span class="string">'/ab*cd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'ab*cd'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// will match /abe and /abcde</span></span><br><span class="line">app.get(<span class="string">'/ab(cd)?e'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'ab(cd)?e'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// will match anything with an a in the route name:</span></span><br><span class="line">app.get(<span class="regexp">/a/</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'/a/'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// will match butterfly, dragonfly; but not butterflyman, dragonfly man, and so on</span></span><br><span class="line">app.get(<span class="regexp">/.*fly$/</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'/.*fly$/'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如你所见，路由的模式匹配其实很简单。你可以使用正则，让你的路由回调更加随心所欲的匹配不同的路径。</p>
<p>路由参数的意思就是你可以在路由配置时定义好路径中带有的参数，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/book/:bookId'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.params);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这样你就可以在回调中，处理<code>req</code>中的<code>params</code>对象。</p>
<h2 id="路由回调"><a href="#路由回调" class="headerlink" title="路由回调"></a>路由回调</h2><p>有时候我们可能会有这样一个需求，我需要在路由回调中进行一些预处理。比如下面这个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user/:id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.params.id === <span class="number">0</span>) &#123;</span><br><span class="line">        next(<span class="string">'route'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'regular'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user/:id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'special'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>上面的示例代码，有两点需要注意，</p>
<p><strong>1.</strong>我们可以在路由配置的回调中，添加多个回调函数。如果有多个回调，我们可以有两种形式，如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, [callback1, callback2, callback3]);</span><br></pre></td></tr></table></figure>
<p><strong>2.</strong>同一个路由配置的多个回调函数在执行时可以被跳过。</p>
<p>上面代码中的<code>next(&#39;route&#39;)</code>表示<strong>跳过</strong>当前路由中间件中剩下的路由回调，执行下一个中间件。而<code>next()</code>表示执行当前中间件的下一个路由回调。所以，当我请求<code>/user/100</code>时，返回的是regular。当我请求<code>/user/0</code>时，返回的是special。</p>
<h2 id="app-router"><a href="#app-router" class="headerlink" title="app.router()"></a><code>app.router()</code></h2><p>在express4中我们可以使用<code>app.router</code>对同一个路径做不同的请求方法配置，如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.route(<span class="string">'/book'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.send(<span class="string">'Get a random book'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.send(<span class="string">'Add a book'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .put(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.send(<span class="string">'Update the book'</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>其实这种方式在路由中间件中也是可以用的。针对特定的路由定制场景是特别适用的，可以更好的模块化、节省一些冗余的代码。</p>
<h1 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h1><p>之前我们的示例代码中，都是简单是使用<code>res.send</code>给客户端发送简单的文本。如果我们想要客户端渲染一个自定义的页面，那该怎么做呢？</p>
<p>这就需要用到模板了。严格来说，express使用的模板属于服务端模板，因为它是在服务端解析完毕，发送给客户端进行渲染的。express支持很多<a href="https://github.com/strongloop/express/wiki#template-engines" target="_blank" rel="external">模板引擎</a>，基本上将市面上常见模板引擎一网打尽了。express默认的模板引擎是<a href="https://github.com/jadejs/jade" target="_blank" rel="external">jade</a>，一款非常优雅的模板引擎。后面博主会有文章介绍jade。</p>
<p>言归正传，我们在express中如何使用模板引擎来加载模板呢？其实很简单，三步走即可，</p>
<ol>
<li>设置好模板的静态路径</li>
<li>设置好渲染的模板引擎</li>
<li>在需要的地方渲染你的模板</li>
</ol>
<p>具体看下面的示例代码，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 省略无关代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置模板文件夹的路径</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line"><span class="comment">// 设置模板文件的后缀名</span></span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">    res.render(<span class="string">'index'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/about'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">'about'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/article'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">'article'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略无关代码</span></span><br></pre></td></tr></table></figure>
<p>我们在<code>views</code>目录下有3个模板，分别为<code>views/index.jade</code>，<code>views/about.jade</code>，<code>views/article.jade</code>，当请求不同的路径时，我们会发送不同的模板给前端渲染。</p>
<p>如果你使用的是别的模板引擎，请参阅模板引擎针对express的相关说明。</p>
<p>本文由于篇幅原因，不会关注express的方方面面，更多的内容请参考官网的<a href="http://expressjs.com/4x/api.html" target="_blank" rel="external">API Reference</a></p>


            <div class="post-info">
    <p class="eof">- EOF -</p>
    <p class="copyright">All rights reserved <a href="http://gejiawen.github.io/about">@gejiawen</a>.</p>
    <p class="link">本文链接：<a href="http://blog.gejiawen.com/2015/08/13/first-to-express4-guide/">http://blog.gejiawen.com/2015/08/13/first-to-express4-guide/</a></p>

    <div class="share">
    分享本页：
    
        <div class="bdsharebuttonbox"><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a><a href="#" class="bds_more" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

    
    
</div>

</div>


            
    <section class="comment">
    <div class="ds-thread" data-thread-key="first-to-express4-guide" data-title="Express4入门指南" data-url="http://blog.gejiawen.com/2015/08/13/first-to-express4-guide/" data-author-key="gejiawen"></div>
</section>


<script type="text/javascript">
var duoshuoQuery = {short_name:"gejiawen-blog"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>





        </div>
    </div>
</article>

    <footer id="footer">
        <div id="bottom-tip">
            蛋糕仙人 —— <small>技术人需要危机感</small>
        </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，搭载 <a href="https://github.com/gejiawen/hexadillax2" target="_blank">Hexadillax2</a> 主题</small><br />
        <!--<small>如果你访问github速度过慢，可移步本站的备份站点<a href="http://gejiawen.gitcafe.io">gejiawen.gitcafe.io</a></small><br />-->
        <small>&copy; 2017 <a href="http://blog.gejiawen.com" target="_blank">gejiawen</a>&nbsp;<a href="http://www.miitbeian.gov.cn/" target="_blank">皖ICP备16008778号</a></small>
    </footer>
    
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e4dd778a6204eb51e4f25460e37481ad";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=58628762" charset="UTF-8"></script>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-51347904-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>

