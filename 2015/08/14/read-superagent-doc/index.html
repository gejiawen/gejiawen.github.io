

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    
    <meta name="author" content="gejiawen">
    
    <meta name="description" content="本文主要参考superagent的官方文档，基本上就是它的翻译。
题外话，superagent真是一个不错的nodejs模块，推荐使用。
前言superagent是一个流行的nodejs第三方模块，专注于处理服务端/客户端的http请求。
在nodejs中，我们可以使用内置的http等模块来进行请求">
    
    

    
    <link rel="alternative" href="atom.xml" title="蛋糕仙人" type="application/atom+xml">
    
    
    

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>通读SuperAgent文档 | 蛋糕仙人 · 技术人需要危机感</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Javascript -->
    <script src="/js/jquery-2.1.0.min.js"></script>
    <script src="/js/jquery.backstretch.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/headroom.min.js"></script>
    <script src="/js/jquery.headroom.min.js"></script>
    <script src="/js/common.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    
    <meta name="baidu-site-verification" content="SzJ3MGdmeo" />


    <meta name="360-site-verification" content="afe5dc96bbb8d111b618f78493b95bb8" />


    <!--<meta name="baidu-site-verification" content="SzJ3MGdmeo" />-->
    <!--<meta name="360-site-verification" content="afe5dc96bbb8d111b618f78493b95bb8" />-->

</head>
<body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="banner">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://blog.gejiawen.com" title="蛋糕仙人">蛋糕仙人</a>
            </div>

            <div role="navigation" class="collapse navbar-collapse bs-navbar-collapse">
                
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a class="max-width max-w300" title="技术人需要危机感" href="/feelings">技术人需要危机感</a>
                    </li>
                </ul>
                

                <ul class="nav navbar-nav">
                    
                    <li id="nav-index">
                        <a href="/" target="">首页</a>
                    </li>
                    
                    <li id="nav-archives">
                        <a href="/archives" target="">归档</a>
                    </li>
                    
                    <li id="nav-categories">
                        <a href="/categories" target="">分类</a>
                    </li>
                    
                    <li id="nav-tags">
                        <a href="/tags" target="">标签</a>
                    </li>
                    
                    <li id="nav-pick">
                        <a href="http://book.gejiawen.com/fucking-days-to-be-a-coder" target="_blank">拾遗</a>
                    </li>
                    
                    <li id="nav-about">
                        <a href="/about" target="">关于</a>
                    </li>
                    

                    <li id="nav-github"><a href="https://github.com/gejiawen" target="_blank">GitHub</a></li>
                    <!--<li id="nav-rss"><a href="/atom.xml" target="_blank">Rss</a></li>-->
                    <li id="nav-search"><input type="text" id="search" placeholder="search" /></li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
    var bgRoot = "http://7xkwt1.com1.z0.glb.clouddn.com/background-";
    var bgLength = "74";
    var bgRandom = false;
    var bgImage = "http://7xkwt1.com1.z0.glb.clouddn.com/background-64.jpg";

    $(function() {
        // page-id...
        var pageId = "2015/08/14/read-superagent-doc/";
        pageId = pageId.substr(0, pageId.indexOf("/"));
        if(pageId === "") pageId = "index";

        $("#nav-" + pageId).addClass("active");
    });
    </script>

    <article class="post container">
    <div class="well post-body first-post last-post">
        <h1>通读SuperAgent文档</h1>

        <div class="time-info">
            
<span class="article-tags">
    
    Tags: <a href="/tags/nodejs/">nodejs</a>&nbsp;<a href="/tags/漫游NodeJS系列/">漫游NodeJS系列</a>&nbsp;<a href="/tags/翻译/">翻译</a>&nbsp;<a href="/tags/中文文档/">中文文档</a>&nbsp;<a href="/tags/superagent/">superagent</a>&nbsp;
</span>



<span class="article-categories">
    Category:
    <a class="article-category-link" href="/categories/NODEJS/">NODEJS</a>
</span>


        </div>
        <div class="time-info">
            发表: <time datetime="2015-08-14T08:51:17.000Z"
                       itemprop="datePublished">2015-08-14 16:51:17</time>
            
            更新: <time datetime="2017-01-15T17:16:24.000Z"
                       itemprop="dateModified">2017-01-16 01:16:24</time>
            
        </div>

        <div class="post-body-inner">
            
                <div id="toc" class="toc-article well">
                    <strong class="toc-title">大纲</strong>
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基本用法"><span class="toc-number">2.</span> <span class="toc-text">基本用法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设置请求头"><span class="toc-number">3.</span> <span class="toc-text">设置请求头</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GET请求"><span class="toc-number">4.</span> <span class="toc-text">GET请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HEAD请求"><span class="toc-number">5.</span> <span class="toc-text">HEAD请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#POST-PUT请求"><span class="toc-number">6.</span> <span class="toc-text">POST/PUT请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设置Content-Type"><span class="toc-number">7.</span> <span class="toc-text">设置Content-Type</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#设置Accept"><span class="toc-number">8.</span> <span class="toc-text">设置Accept</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#查询字符串"><span class="toc-number">9.</span> <span class="toc-text">查询字符串</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解析响应体"><span class="toc-number">10.</span> <span class="toc-text">解析响应体</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-Urlencoded"><span class="toc-number">10.1.</span> <span class="toc-text">JSON/Urlencoded</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multipart"><span class="toc-number">10.2.</span> <span class="toc-text">Multipart</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#响应体属性"><span class="toc-number">11.</span> <span class="toc-text">响应体属性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-Text"><span class="toc-number">11.1.</span> <span class="toc-text">Response Text</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-Body"><span class="toc-number">11.2.</span> <span class="toc-text">Response Body</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-header-fields"><span class="toc-number">11.3.</span> <span class="toc-text">Response header fields</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-Content-Type"><span class="toc-number">11.4.</span> <span class="toc-text">Response Content-Type</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Response-Status"><span class="toc-number">11.5.</span> <span class="toc-text">Response Status</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#中断请求"><span class="toc-number">12.</span> <span class="toc-text">中断请求</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#请求超时"><span class="toc-number">13.</span> <span class="toc-text">请求超时</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基本授权"><span class="toc-number">14.</span> <span class="toc-text">基本授权</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#跟随重定向"><span class="toc-number">15.</span> <span class="toc-text">跟随重定向</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#管道数据"><span class="toc-number">16.</span> <span class="toc-text">管道数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#复合请求"><span class="toc-number">17.</span> <span class="toc-text">复合请求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#附加文件"><span class="toc-number">17.1.</span> <span class="toc-text">附加文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#字段值"><span class="toc-number">17.2.</span> <span class="toc-text">字段值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#压缩"><span class="toc-number">18.</span> <span class="toc-text">压缩</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#缓冲响应"><span class="toc-number">19.</span> <span class="toc-text">缓冲响应</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#跨域资源共享"><span class="toc-number">20.</span> <span class="toc-text">跨域资源共享</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#异常处理"><span class="toc-number">21.</span> <span class="toc-text">异常处理</span></a></li></ol>
                </div>
            

            <p>本文主要参考superagent的<a href="http://visionmedia.github.io/superagent/" target="_blank" rel="external">官方文档</a>，基本上就是它的翻译。</p>
<p>题外话，superagent真是一个不错的nodejs模块，推荐使用。</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://github.com/visionmedia/superagent" target="_blank" rel="external">superagent</a>是一个流行的nodejs第三方模块，专注于处理服务端/客户端的http请求。</p>
<p>在nodejs中，我们可以使用内置的http等模块来进行请求的发送、响应处理等操作，不过superagent提供了更加简单、优雅的API，让你在处理请求时更加方便。而且它很轻量，学习曲线平滑，内部其实就是对内置模块的封装。</p>
<p>下面让我们先来看一个简单的例子，大致的了解下request的基本用法，以及它和使用内置模块的区别。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'superagent'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">var</span> queryString = <span class="built_in">require</span>(<span class="string">'queryString'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用superagent</span></span><br><span class="line">request</span><br><span class="line">    .post(<span class="string">'/api/pet'</span>)</span><br><span class="line">    .send(&#123; name: <span class="string">'Manny'</span>, species: <span class="string">'cat'</span> &#125;)</span><br><span class="line">    .set(<span class="string">'X-API-Key'</span>, <span class="string">'foobar'</span>)</span><br><span class="line">    .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">err, res</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (res.ok) &#123;</span><br><span class="line">            alert(<span class="string">'yay got '</span> + <span class="built_in">JSON</span>.stringify(res.body));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alert(<span class="string">'Oh no! error '</span> + res.text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用http</span></span><br><span class="line"><span class="keyword">var</span> postData = queryString.stringify(&#123;name: <span class="string">'Manny'</span>, species: <span class="string">'cat'</span>&#125;);</span><br><span class="line"><span class="keyword">var</span> options = &#123;</span><br><span class="line">    path: <span class="string">'/api/pet'</span>,</span><br><span class="line">    method: <span class="string">'POST'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">'X-API-Key'</span>: <span class="string">'foobar'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> req = http.request(options, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    res.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(chunk);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">req.write(postData);</span><br><span class="line">req.end();</span><br></pre></td></tr></table></figure>
<p>从上面的代码中，我们可以看出，使用superagent发送一个post请求，并设置了相关请求头信息（可以链式操作），相比较使用内置的模块，要简单很多。</p>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><p>在<code>var request = require(&#39;superagent&#39;)</code>之后，<code>request</code>对象上将会有许多方法可供使用。我们可以使用<code>get</code>、<code>post</code>等方法名来声明一个get或者post请求，然后再通过<code>end()</code>方法来发出请求。下面是个例子。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>这里有一点需要注意，就是只要当调用了<code>end()</code>方法之后，这个请求才会发出。在调用<code>end()</code>之前的所有动作其实都是对请求的配置。</p>
<p>我们在具体使用时，还可以将请求方法作为字符串参数，比如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request(<span class="string">'GET'</span>, <span class="string">'/search'</span>).end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>在nodejs客户端中，还可以提供绝对路径，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'http://www.baidu.com/search'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>其余的http谓语动词也是可以使用，比如<strong>DELETE</strong>、<strong>HEAD</strong>、<strong>POST</strong>、<strong>PUT</strong>等等。使用的时候，我们只需要变更<code>request[METHOD]</code>中的<code>METHOD</code>即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .head(<span class="string">'/favicon.ico'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>不过，针对<strong><code>DELETE</code></strong>方法，有一点不同，因为<code>delete</code>是一个保留关键字，所以我在使用的时候应该是使用<strong><code>del()</code></strong>而不是<code>delete()</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .del(<span class="string">'/user/111'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>superagent默认的http方法是<strong>GET</strong>。就是说，如果你的请求是<code>get</code>请求，那么你可以省略http方法的相关配置。懒人必备。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request(<span class="string">'/search'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, res</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="设置请求头"><a href="#设置请求头" class="headerlink" title="设置请求头"></a>设置请求头</h1><p>在之前的例子中，我们看到使用内置的http模块在设置请求头信息时，要求传递给<code>http.request</code>一个<code>options</code>，这个<code>options</code>包含了所有的请求头信息。相对这种方式，superagent提供了一种更佳简单优雅的方式。在superagent中，设置头信息，使用<code>set()</code>方法即可，而且它有多种形式，必能满足你的需求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传递key-value键值对，可以一次设置一个头信息</span></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search'</span>)</span><br><span class="line">    .set(<span class="string">'X-API-Key'</span>, <span class="string">'foobar'</span>)</span><br><span class="line">    .set(<span class="string">'Accept'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传递对象，可以一次设置多次头信息</span></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search2'</span>)</span><br><span class="line">    .set(&#123;</span><br><span class="line">        <span class="string">'API-Key'</span>: <span class="string">'foobar'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="GET请求"><a href="#GET请求" class="headerlink" title="GET请求"></a>GET请求</h1><p>在使用<code>super.get</code>处理GET请求时，我们可以使用<code>query()</code>来处理请求字符串。比如，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search'</span>)</span><br><span class="line">    .query(&#123;name: <span class="string">'Manny'</span>&#125;)</span><br><span class="line">    .query(&#123;range: <span class="string">'1..5'</span>&#125;)</span><br><span class="line">    .query(&#123;order: <span class="string">'desc'</span>&#125;)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>上面的代码将会发出一个<code>/search?name=Manny&amp;range=1..5&amp;order=desc</code>的请求。</p>
<p>我们可以使用<code>query()</code>传递一个大对象，将所有的查询参数都写入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search'</span>)</span><br><span class="line">    .query(&#123;</span><br><span class="line">        name: <span class="string">'Manny'</span>,</span><br><span class="line">        range: <span class="string">'1..5'</span>,</span><br><span class="line">        order: <span class="string">'desc'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>我们还可以简单粗暴的直接将整个查询字符串拼接起来作为<code>query()</code>的参数，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search'</span>)</span><br><span class="line">    .query(<span class="string">'name=Manny&amp;range=1..5&amp;order=desc'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>或者是实时拼接字符串，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">'Manny'</span>;</span><br><span class="line"><span class="keyword">var</span> range = <span class="string">'1..5'</span>;</span><br><span class="line"><span class="keyword">var</span> order = <span class="string">'desc'</span>;</span><br><span class="line"></span><br><span class="line">request</span><br><span class="line">    .get(<span class="string">'/search'</span>)</span><br><span class="line">    .query(<span class="string">'name='</span> + name)</span><br><span class="line">    .query(<span class="string">'range='</span> + range)</span><br><span class="line">    .query(<span class="string">'order='</span> + order)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="HEAD请求"><a href="#HEAD请求" class="headerlink" title="HEAD请求"></a>HEAD请求</h1><p>在<code>request.head</code>请求中，我们也可以使用<code>query()</code>来设置参数，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .head(<span class="string">'/users'</span>)</span><br><span class="line">    .query(&#123;</span><br><span class="line">        email: <span class="string">'joe@gmail.com'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>上面的代码将会发出一个<code>/users?email=joe@gamil.com</code>的请求。</p>
<h1 id="POST-PUT请求"><a href="#POST-PUT请求" class="headerlink" title="POST/PUT请求"></a>POST/PUT请求</h1><p>一个典型的json post请求看起来像下面这样，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/user'</span>)</span><br><span class="line">    .set(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">    .send(<span class="string">'&#123;"name": "tj", "pet": "tobi"&#125;'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<p>我们通过<code>set()</code>设置一个合适的<code>Content-Type</code>，然后通过<code>send()</code>写入一些post data，最后通过<code>end()</code>发出这个post请求。注意这里我们<code>send()</code>的参数是一个json字符串。</p>
<p>因为json格式现在是一个通用的标准，所以默认的<code>Content-Type</code>就是json格式。下面的代码跟前一个示例是等价的，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/user'</span>)</span><br><span class="line">    .send(&#123;name: <span class="string">"tj"</span>, pet: <span class="string">"tobi"</span>&#125;)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<p>我们也可以使用多个<code>send()</code>拼接post data，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/user'</span>)</span><br><span class="line">    .send(&#123;name: <span class="string">"tj"</span>&#125;)</span><br><span class="line">    .send(&#123;pet: <span class="string">'tobi'</span>&#125;)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<p><code>send()</code>方法发送字符串时，将默认设置<code>Content-Type</code>为<code>application/x-www-form-urlencoded</code>，多次<code>send()</code>的调用，将会使用<code>&amp;</code>将所有的数据拼接起来。比如下面这个例子，我们发送的数据将为<code>name=tj&amp;per=tobi</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/user'</span>)</span><br><span class="line">    .send(<span class="string">'name=tj'</span>)</span><br><span class="line">    .send(<span class="string">'pet=tobi'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<p>superagent的请求数据格式化是可以扩展的，不过默认支持<code>form</code>和<code>json</code>两种格式，想发送数据以<code>application/x-www-form-urlencoded</code>类型的话，则可以简单的调用<code>type()</code>方法传递<code>form</code>参数就行，<code>type()</code>方法的默认参数是<code>json</code>。</p>
<p>下面的代码将会使用<code>&quot;name=tj&amp;pet=tobi&quot;</code>来发出一个post请求。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/user'</span>)</span><br><span class="line">    .type(<span class="string">'form'</span>)</span><br><span class="line">    .send(&#123;name: <span class="string">'tj'</span>&#125;)</span><br><span class="line">    .send(&#123;pet: <span class="string">'tobi'</span>&#125;)</span><br><span class="line">    end(callback);</span><br></pre></td></tr></table></figure>
<h1 id="设置Content-Type"><a href="#设置Content-Type" class="headerlink" title="设置Content-Type"></a>设置Content-Type</h1><p>设置<code>Content-Type</code>最常用的方法就是使用<code>set()</code>，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/user'</span>)</span><br><span class="line">    .set(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<p>另一个简便的方法是调用<code>type()</code>方法，传递一个规范的<code>MIME</code>名称，包括<code>type/subtype</code>，或者是一个简单的后缀就像<code>xml</code>，<code>json</code>，<code>png</code>这样。比如，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.post(<span class="string">'/user'</span>).type(<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line">request.post(<span class="string">'/user'</span>).type(<span class="string">'json'</span>)</span><br><span class="line"></span><br><span class="line">request.post(<span class="string">'/user'</span>).type(<span class="string">'png'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="设置Accept"><a href="#设置Accept" class="headerlink" title="设置Accept"></a>设置Accept</h1><p>跟<code>type()</code>类似，设置accept也可以简单的调用<code>accept()</code>。参数接受一个规范的<code>MIME</code>名称，包括<code>type/subtype</code>，或者是一个简单的后缀就像<code>xml</code>，<code>json</code>，<code>png</code>这样。这个参数值将会被<code>request.types</code>所引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'/user'</span>).accept(<span class="string">'application/json'</span>)</span><br><span class="line"></span><br><span class="line">request.get(<span class="string">'/user'</span>).accept(<span class="string">'json'</span>)</span><br><span class="line"></span><br><span class="line">request.get(<span class="string">'/user'</span>).accept(<span class="string">'png'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="查询字符串"><a href="#查询字符串" class="headerlink" title="查询字符串"></a>查询字符串</h1><p>当用<code>send(obj)</code>方法来发送一个post请求，并且希望传递一些查询字符串时，可以调用<code>query()</code>方法，比如向<code>?format=json&amp;dest=/login</code>发送post请求，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/'</span>)</span><br><span class="line">    .query(&#123;format: <span class="string">'json'</span>&#125;)</span><br><span class="line">    .query(&#123;dest: <span class="string">'/login'</span>&#125;)</span><br><span class="line">    .send(&#123;post: <span class="string">'data'</span>, here: <span class="string">'wahoo'</span>&#125;)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<h1 id="解析响应体"><a href="#解析响应体" class="headerlink" title="解析响应体"></a>解析响应体</h1><p>superagent会解析一些常用的格式给请求者，当前支持<code>application/x-www-form-urlencoded</code>，<code>application/json</code>，<code>multipart/form-data</code>。</p>
<h2 id="JSON-Urlencoded"><a href="#JSON-Urlencoded" class="headerlink" title="JSON/Urlencoded"></a>JSON/Urlencoded</h2><p>此种情况下，<code>res.body</code>是一个解析过的对象。比如一个请求的响应是一个json字符串<code>&#39;{&quot;user&quot;: {&quot;name&quot;: &quot;tobi&quot;}}&#39;</code>，那么<code>res.body.user.name</code>将会返回<code>tobi</code>。</p>
<p>同样的，<code>x-www-form-urlencoded</code>格式的<code>user[name]=tobi</code>解析完的值是一样的。</p>
<h2 id="Multipart"><a href="#Multipart" class="headerlink" title="Multipart"></a>Multipart</h2><p>nodejs客户端通过<a href="https://github.com/felixge/node-formidable" target="_blank" rel="external">Formidable</a>模块来支持<code>multipart/form-data</code>类型，当解析一个<code>multipart</code>响应时，<code>res.files</code>属性就可以用了。假设一个请求响应下面的数据，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--whoop</span><br><span class="line">Content-Disposition: attachment; name=&quot;image&quot;; filename=&quot;tobi.png&quot;</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">... data here ...</span><br><span class="line">--whoop</span><br><span class="line">Content-Disposition: form-data; name=&quot;name&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">Tobi</span><br><span class="line">--whoop--</span><br></pre></td></tr></table></figure>
<p>你将可以获取到<code>res.body.name</code>名为<code>&#39;Tobi&#39;</code>，<code>res.files.image</code>为一个<strong>file</strong>对象，包括一个磁盘文件路径，文件名称，还有其它的文件属性等。</p>
<h1 id="响应体属性"><a href="#响应体属性" class="headerlink" title="响应体属性"></a>响应体属性</h1><p><code>response</code>对象设置了许多有用的标识和属性。包括<code>response.text</code>，解析后的<code>respnse.body</code>，头信息，返回状态标识等。</p>
<h2 id="Response-Text"><a href="#Response-Text" class="headerlink" title="Response Text"></a>Response Text</h2><p><code>res.text</code>包含未解析前的响应内容。基于节省内存和性能因素的原因，一般只在mime类型能够匹配<code>text/</code>，<code>json</code>，<code>x-www-form-urlencoding</code>的情况下默认为nodejs客户端提供。因为当响应以文件或者图片等大体积文件的情况下将会影响性能。</p>
<h2 id="Response-Body"><a href="#Response-Body" class="headerlink" title="Response Body"></a>Response Body</h2><p>跟请求数据自动序列化一样，响应数据也会自动的解析。当<code>Content-Type</code>定义一个解析器后，就能自动解析，默认解析的Content-Type包含<code>application/json</code>和<code>application/x-www-form-urlencoded</code>，可以通过访问<code>res.body</code>来访问解析对象。</p>
<h2 id="Response-header-fields"><a href="#Response-header-fields" class="headerlink" title="Response header fields"></a>Response header fields</h2><p><code>res.header</code>包含解析之后的响应头数据，键值都是小写字母形式，比如<code>res.header[&#39;content-length&#39;]</code>。</p>
<h2 id="Response-Content-Type"><a href="#Response-Content-Type" class="headerlink" title="Response Content-Type"></a>Response Content-Type</h2><p><code>Content-Type</code>响应头字段是一个特列，服务器提供<code>res.type</code>来访问它，同时<code>res.charset</code>默认是空的。比如，Content-Type值为<code>text/html; charset=utf8</code>，则<code>res.type</code>为<code>text/html</code>，<code>res.charset</code>为<code>utf8</code>。</p>
<h2 id="Response-Status"><a href="#Response-Status" class="headerlink" title="Response Status"></a>Response Status</h2><p>响应状态标识可以用来判断请求是否成功以及一些其他的额外信息。除此之外，还可以用superagent来构建理想的restful服务器。目前提供的标识定义如下，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> type = status / <span class="number">100</span> | <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// status / class</span></span><br><span class="line">res.status = status;</span><br><span class="line">res.statusType = type;</span><br><span class="line"></span><br><span class="line"><span class="comment">// basics</span></span><br><span class="line">res.info = <span class="number">1</span> == type;</span><br><span class="line">res.ok = <span class="number">2</span> == type;</span><br><span class="line">res.clientError = <span class="number">4</span> == type;</span><br><span class="line">res.serverError = <span class="number">5</span> == type;</span><br><span class="line">res.error = <span class="number">4</span> == type || <span class="number">5</span> == type;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sugar</span></span><br><span class="line">res.accepted = <span class="number">202</span> == status;</span><br><span class="line">res.noContent = <span class="number">204</span> == status || <span class="number">1223</span> == status;</span><br><span class="line">res.badRequest = <span class="number">400</span> == status;</span><br><span class="line">res.unauthorized = <span class="number">401</span> == status;</span><br><span class="line">res.notAcceptable = <span class="number">406</span> == status;</span><br><span class="line">res.notFound = <span class="number">404</span> == status;</span><br><span class="line">res.forbidden = <span class="number">403</span> == status;</span><br></pre></td></tr></table></figure>
<h1 id="中断请求"><a href="#中断请求" class="headerlink" title="中断请求"></a>中断请求</h1><p>要想中断请求，可以简单的调用<code>request.abort()</code>即可。</p>
<h1 id="请求超时"><a href="#请求超时" class="headerlink" title="请求超时"></a>请求超时</h1><p>可以通过<code>request.timeout()</code>来定义超时时间。当超时错误发生时，为了区别于别的错误，<code>err.timeout</code>属性被定义为超时时间（一个<code>ms</code>的值）。注意，当超时错误发生后，后续的请求都会被重定向。意思就说超时是针对所有的请求而不是单个某个请求。</p>
<h1 id="基本授权"><a href="#基本授权" class="headerlink" title="基本授权"></a>基本授权</h1><p>nodejs客户端目前提供两种基本授权的方式。</p>
<p>一种是通过类似下面这样的url，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.get(<span class="string">'http://tobi:learnboost@local'</span>).end(callback);</span><br></pre></td></tr></table></figure>
<p>意思就是说要求在url中指明<code>user:password</code>。</p>
<p>第二种方式就是通过<code>auth()</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'http://local'</span>)</span><br><span class="line">    .auth(<span class="string">'tobi'</span>, <span class="string">'learnboost'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<h1 id="跟随重定向"><a href="#跟随重定向" class="headerlink" title="跟随重定向"></a>跟随重定向</h1><p>默认是向上跟随5个重定向，不过可以通过调用<code>res.redirects(n)</code>来设置个数，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'/some.png'</span>)</span><br><span class="line">    .redirects(<span class="number">2</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<h1 id="管道数据"><a href="#管道数据" class="headerlink" title="管道数据"></a>管道数据</h1><p>nodejs客户端允许使用一个请求流来输送数据。比如请求一个文件作为输出流，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'superagent'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stream = fs.createReadStream(<span class="string">'path/to/my.json'</span>);</span><br><span class="line"><span class="keyword">var</span> req = request.post(<span class="string">'/somewhere'</span>);</span><br><span class="line">req.type(<span class="string">'json'</span>);</span><br><span class="line">stream.pipe(req);</span><br></pre></td></tr></table></figure>
<p>或者将一个响应流写到文件中，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">'superagent'</span>)</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stream = fs.createWriteStream(<span class="string">'path/to/my.json'</span>);</span><br><span class="line"><span class="keyword">var</span> req = request.get(<span class="string">'/some.json'</span>);</span><br><span class="line">req.pipe(stream);</span><br></pre></td></tr></table></figure>
<h1 id="复合请求"><a href="#复合请求" class="headerlink" title="复合请求"></a>复合请求</h1><p>superagent用来构建复合请求非常不错，提供了低级和高级的api方法。</p>
<p>低级的api是使用多个部分来表现一个文件或者字段，<code>part()</code>方法返回一个新的部分，提供了跟request本身相似的api方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> req = request.post(<span class="string">'/upload'</span>);</span><br><span class="line"></span><br><span class="line">req.part()</span><br><span class="line">    .set(<span class="string">'Content-Type'</span>, <span class="string">'image/png'</span>)</span><br><span class="line">    .set(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment; filename="myimage.png"'</span>)</span><br><span class="line">    .write(<span class="string">'some image data'</span>)</span><br><span class="line">    .write(<span class="string">'some more image data'</span>);</span><br><span class="line"></span><br><span class="line">req.part()</span><br><span class="line">    .set(<span class="string">'Content-Disposition'</span>, <span class="string">'form-data; name="name"'</span>)</span><br><span class="line">    .set(<span class="string">'Content-Type'</span>, <span class="string">'text/plain'</span>)</span><br><span class="line">    .write(<span class="string">'tobi'</span>);</span><br><span class="line"></span><br><span class="line">req.end(callback);</span><br></pre></td></tr></table></figure>
<h2 id="附加文件"><a href="#附加文件" class="headerlink" title="附加文件"></a>附加文件</h2><p>上面提及的高级api方法，可以通用<code>attach(name, [path], [filename])</code>和<code>field(name, value)</code>这两种形式来调用。添加多个附件也比较简单，只需要给附件提供自定义的文件名称，同样的基础名称也要提供。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/upload'</span>)</span><br><span class="line">    .attach(<span class="string">'avatar'</span>, <span class="string">'path/to/tobi.png'</span>, <span class="string">'user.png'</span>)</span><br><span class="line">    .attach(<span class="string">'image'</span>, <span class="string">'path/to/loki.png'</span>)</span><br><span class="line">    .attach(<span class="string">'file'</span>, <span class="string">'path/to/jane.png'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<h2 id="字段值"><a href="#字段值" class="headerlink" title="字段值"></a>字段值</h2><p>跟html的字段很像，你可以调用<code>field(name, value)</code>方法来设置字段。假设你想上传一个图片的时候带上自己的名称和邮箱，那么你可以像下面写的那样，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/upload'</span>)</span><br><span class="line">    .field(<span class="string">'user[name]'</span>, <span class="string">'Tobi'</span>)</span><br><span class="line">    .field(<span class="string">'user[email]'</span>, <span class="string">'tobi@learnboost.com'</span>)</span><br><span class="line">    .attach(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line">    .end(callback);</span><br></pre></td></tr></table></figure>
<h1 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h1><p>nodejs客户端本身对响应体就做了压缩，而且做的很好。所以这块你不需要做额外的事情了。</p>
<h1 id="缓冲响应"><a href="#缓冲响应" class="headerlink" title="缓冲响应"></a>缓冲响应</h1><p>当想要强制缓冲<code>res.text</code>这样的响应内容时，可以调用<code>buffer()</code>方法。想取消默认的文本缓冲响应，比如<code>text/plain</code>，<code>text/html</code>这样的，可以调用<code>buffer(false)</code>方法。</p>
<p>一旦设置了缓冲标识<code>res.buffered</code>，那么就可以在一个回调函数里处理缓冲和没缓冲的响应。</p>
<h1 id="跨域资源共享"><a href="#跨域资源共享" class="headerlink" title="跨域资源共享"></a>跨域资源共享</h1><p><code>withCredentials()</code>方法可以激活发送原始cookie的能力。不过只有在<strong>Access-Control-Allow-Origin</strong>不是一个通配符(<em>)，并且<em>*Access-Control-Allow-Credentials</em></em>为<code>true</code>的情况下才可以。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .get(<span class="string">'http://localhost:4001/'</span>)</span><br><span class="line">    .withCredentials()</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">err, res, next</span>)</span>&#123;</span><br><span class="line">        assert(<span class="number">200</span> == res.status);</span><br><span class="line">        assert(<span class="string">'tobi'</span> == res.text);</span><br><span class="line">        next();</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><p>当请求出错时，superagent首先会检查回调函数的参数数量，当<strong>err</strong>参数提供的话，参数就是两个，如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/upload'</span>)</span><br><span class="line">    .attach(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">err, res</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>如果没有回调函数，或者回调函数只有一个参数的话，可以添加error事件的处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">request</span><br><span class="line">    .post(<span class="string">'/upload'</span>)</span><br><span class="line">    .attach(<span class="string">'image'</span>, <span class="string">'path/to/tobi.png'</span>)</span><br><span class="line">    .on(<span class="string">'error'</span>, errorHandle)</span><br><span class="line">    .end(<span class="function"><span class="keyword">function</span>(<span class="params">res</span>)</span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>注意：superagent<strong>不认为</strong>返回<strong>4xx</strong>和<strong>5xx</strong>的情况是错误。比如当请求返回500或者403之类的状态码时，可以通过<code>res.error</code>或者<code>res.status</code>等属性来查看。此时并不会有错误对象传递到回调函数中。当发生网络错误或者解析错误时，superagent才会认为是发生了请求错误，此时会传递一个错误对象<code>err</code>作为回调函数的第一个参数。</p>
<p>当产生一个4xx或者5xx的http响应，<code>res.error</code>提供了一个错误信息的对象，你可以通过检查这个来做某些事情。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (err &amp;&amp; err.status === <span class="number">404</span>) &#123;</span><br><span class="line">    alert(<span class="string">'oh no '</span> + res.body.message);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="comment">// all other error types we handle generically</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


            <div class="post-info">
    <p class="eof">- EOF -</p>
    <p class="copyright">All rights reserved <a href="http://gejiawen.github.io/about">@gejiawen</a>.</p>
    <p class="link">本文链接：<a href="http://blog.gejiawen.com/2015/08/14/read-superagent-doc/">http://blog.gejiawen.com/2015/08/14/read-superagent-doc/</a></p>

    <div class="share">
    分享本页：
    
        <div class="bdsharebuttonbox"><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a><a href="#" class="bds_more" data-cmd="more"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

    
    
</div>

</div>


            
    <section class="comment">
    <div class="ds-thread" data-thread-key="read-superagent-doc" data-title="通读SuperAgent文档" data-url="http://blog.gejiawen.com/2015/08/14/read-superagent-doc/" data-author-key="gejiawen"></div>
</section>


<script type="text/javascript">
var duoshuoQuery = {short_name:"gejiawen-blog"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';
        ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>





        </div>
    </div>
</article>

    <footer id="footer">
        <div id="bottom-tip">
            蛋糕仙人 —— <small>技术人需要危机感</small>
        </div>
        <small>该博客由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动，搭载 <a href="https://github.com/gejiawen/hexadillax2" target="_blank">Hexadillax2</a> 主题</small><br />
        <!--<small>如果你访问github速度过慢，可移步本站的备份站点<a href="http://gejiawen.gitcafe.io">gejiawen.gitcafe.io</a></small><br />-->
        <small>&copy; 2017 <a href="http://blog.gejiawen.com" target="_blank">gejiawen</a>&nbsp;<a href="http://www.miitbeian.gov.cn/" target="_blank">皖ICP备16008778号</a></small>
    </footer>
    
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e4dd778a6204eb51e4f25460e37481ad";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


    <script type="text/javascript" src="http://tajs.qq.com/stats?sId=58628762" charset="UTF-8"></script>


    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-51347904-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>

